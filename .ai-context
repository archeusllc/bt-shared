# Shared Module AI Context

AI agent guide for the Band Together shared types and utilities module.

## Module Overview

**Purpose**: Central repository for shared types, utilities, and generated code accessible to all modules

**Tech Stack**:
- TypeScript (strict mode)
- Prisma Client (generated from database schema)
- Exported types (from API, database, and custom definitions)
- No runtime dependencies (pure types and utilities)

**Repository**: https://github.com/archeusllc/bt-shared (submodule)

## Directory Structure

```
shared/
├── index.ts                   # Main export file
├── generated/                 # Generated content (auto-updated)
│   ├── prisma-client/         # From db/ generation
│   │   └── index.ts           # Prisma client & types
│   └── api-types/             # From api/ generation
│       └── index.ts           # API route types
├── types/                     # Hand-written shared types
│   ├── User.ts                # User type definitions
│   └── ...other types
├── tsconfig.json              # TypeScript config
├── package.json               # Dependencies (minimal)
├── bun.lockb                  # Bun lock file
└── .ai-context                # This file
```

## Key Files & Their Purpose

### `index.ts` - Main Exports

Central export point for all shared code:

```typescript
// Export Prisma client
export { PrismaClient, Prisma } from './generated/prisma-client'

// Export API types
export type { App } from './generated/api-types'

// Export shared types
export type { User, Post, Comment } from './types'

// Export utilities
export { validateEmail, formatDate } from './utils'
```

**Usage in API**:
```typescript
import { PrismaClient } from '@band-together/shared'

const prisma = PrismaClient()
```

**Usage in Client**:
```typescript
import { edenTreaty } from '@elysiajs/eden'
import type { App } from '@band-together/shared'

const api = edenTreaty<App>('http://localhost:3000')
```

### `generated/prisma-client/` - Database Types

Auto-generated from `db/prisma/schema.prisma`:

**Never manually edit** — Auto-generated when you run:
```bash
cd db
bun run generate
```

**Contains**:
- `PrismaClient` class
- All model types (User, Post, etc.)
- Input types (for create/update)
- Type-safe query methods

**Example generated type**:
```typescript
// Auto-generated
type User = {
  id: string
  email: string
  displayName: string | null
  photoUrl: string | null
  createdAt: Date
  updatedAt: Date
}

// Input type for create
type UserCreateInput = {
  email: string
  displayName?: string
  photoUrl?: string
}

// PrismaClient with methods
class PrismaClient {
  user: Delegate<User>
  // All model methods with full types
}
```

### `generated/api-types/` - API Route Types

Auto-generated from API route definitions:

**Never manually edit** — Auto-generated from Elysia routes

**Contains**:
- All endpoint types
- Request/response schemas
- Parameter and query types

**Example generated type**:
```typescript
// Auto-generated from API routes
type App = {
  '/auth/login': {
    POST: {
      body: { email: string; password: string }
      response: {
        user: { id: string; email: string }
      }
    }
  }
  '/profile': {
    GET: {
      response: { id: string; email: string }
    }
    PUT: {
      body: { displayName?: string }
      response: { id: string; email: string }
    }
  }
  // ... more routes
}
```

### `types/User.ts` - Custom Types

Hand-written shared types (not auto-generated):

```typescript
// types/User.ts
export interface User {
  id: string
  email: string
  displayName: string | null
  photoUrl: string | null
  createdAt: Date
  updatedAt: Date
}

export interface UserInput {
  email: string
  displayName?: string
  photoUrl?: string
}

export interface UserProfile extends User {
  // Additional profile fields
}
```

**Usage**:
```typescript
import type { User, UserProfile } from '@band-together/shared'

function displayUser(user: User) {
  return `${user.displayName || user.email}`
}
```

## How Shared Module Works

### Generation Flow

```
Database Schema (db/prisma/schema.prisma)
  ↓
[cd db && bun run migrate:dev]
  ↓
[bun run generate in db/]
  ↓
Prisma Client Generated (db/generated/)
  ↓
[Copy to shared/generated/prisma-client/]
  ↓
API Routes (api/src/routes/)
  ↓
[API types auto-generate]
  ↓
Available in shared/generated/api-types/
  ↓
Client & API import from shared
  ↓
End-to-End Type Safety
```

### What Gets Shared

**From Database**:
- ✅ Prisma client (database access)
- ✅ All model types
- ✅ Input/output types
- ❌ Migrations (not shared)

**From API**:
- ✅ Route types
- ✅ Request/response schemas
- ✅ Endpoint definitions
- ❌ Controllers (not shared)

**Custom**:
- ✅ Shared utility types
- ✅ Domain types
- ✅ Interface definitions
- ❌ Implementation (not shared)

## Usage Patterns

### In API Server

```typescript
// api/src/controllers/user.controller.ts
import { PrismaClient } from '@band-together/shared'

const prisma = PrismaClient()

export const UserController = {
  async getUser(id: string) {
    const user = await prisma.user.findUnique({
      where: { id }
    })
    // user is typed correctly from Prisma client
    return user
  }
}
```

### In Client App

```typescript
// client/src/services/api.ts
import { edenTreaty } from '@elysiajs/eden'
import type { App } from '@band-together/shared'

export const api = edenTreaty<App>('http://localhost:3000')

// In component:
const { data: user } = await api.users[id].get()
// data is typed correctly from App type
```

### Custom Utility Types

```typescript
// types/common.ts
export type ApiResponse<T> = {
  success: boolean
  data?: T
  error?: string
}

export type PaginatedResponse<T> = {
  items: T[]
  total: number
  page: number
  pageSize: number
}

// Usage:
const response: ApiResponse<User> = {
  success: true,
  data: user
}
```

## Common Tasks for AI Agents

### Add Custom Types

1. **Create file in `types/`**:
   ```typescript
   // types/Post.ts
   export interface Post {
     id: string
     title: string
     content: string
     authorId: string
     createdAt: Date
     updatedAt: Date
   }

   export type PostInput = Omit<Post, 'id' | 'createdAt' | 'updatedAt'>
   ```

2. **Export from `index.ts`**:
   ```typescript
   export type { Post, PostInput } from './types/Post'
   ```

3. **Use in API or Client**:
   ```typescript
   import type { Post, PostInput } from '@band-together/shared'
   ```

### Export New Prisma Types

After running `bun run generate` in db/:

1. **Types auto-copy to shared**
2. **Export from `index.ts`**:
   ```typescript
   export type { Post, PostCreateInput, PostUpdateInput } from './generated/prisma-client'
   ```
3. **Use in API/Client**:
   ```typescript
   import type { Post } from '@band-together/shared'
   ```

### Create Utility Functions

```typescript
// utils/validation.ts
export function isValidEmail(email: string): boolean {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)
}

export function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US')
}

// Export from index.ts
export { isValidEmail, formatDate } from './utils/validation'

// Usage anywhere:
import { isValidEmail } from '@band-together/shared'
```

## Type Safety Details

### Prisma Client Types

Generated types are:
- ✅ **Exact match to database schema**
- ✅ **Updated when schema changes**
- ✅ **Include all field constraints**
- ✅ **Have proper null handling**

**Example**:
```typescript
// Database schema
model User {
  id          String
  email       String    @unique
  displayName String?   // Optional
}

// Generated type automatically becomes:
type User = {
  id: string
  email: string
  displayName: string | null  // ← Correctly optional!
}
```

### API Types

Generated types are:
- ✅ **Match API route definitions**
- ✅ **Include all parameters**
- ✅ **Have correct response types**
- ✅ **Update when routes change**

**Example**:
```typescript
// API route
export const postsRoutes = new Elysia()
  .get('/posts/:id', ({ params }) => {
    return { title: '...' }
  })

// Generated type automatically becomes:
type App = {
  '/posts/:id': {
    GET: {
      params: { id: string }
      response: { title: string }
    }
  }
}
```

## Don'ts

### What NOT to Do

❌ **Don't edit `generated/` files** — They auto-update from sources

❌ **Don't store implementation in shared** — Only types and interfaces:
```typescript
// ❌ Bad
export function getUserById(id: string) {
  return prisma.user.findUnique({ where: { id } })
}

// ✅ Good
export type User = { id: string; email: string }
```

❌ **Don't export everything from shared** — Only what's truly needed:
```typescript
// ❌ Bad
export { PrismaClient } // Controllers already have this

// ✅ Good
export type { User, Post } // Type definitions for other modules
```

❌ **Don't create circular dependencies** — Shared should not import from api/client:
```typescript
// ❌ Bad
import { AuthController } from '@band-together/api' // Creates cycle

// ✅ Good
export type { User } // Just types, no imports
```

❌ **Don't manually synchronize types** — Let generation handle it:
```typescript
// ❌ Bad
// Manually duplicate Prisma types in custom file

// ✅ Good
// Export from generated/prisma-client/
export { PrismaClient } from './generated/prisma-client'
```

## Integration Points

### From Database Module

Shared receives:
- Prisma client (database access with types)
- All model types auto-generated from schema

**Triggered by**:
```bash
cd db
bun run generate
# Outputs to db/generated/
# Copied to shared/generated/prisma-client/
```

### From API Module

Shared receives:
- Route types (request/response shapes)
- Endpoint definitions
- Parameter and query types

**Auto-generated when**:
- API server starts
- Routes change
- Types exported to `http://localhost:3000/server.d.ts`

### Exported To API

API uses:
- Prisma client (database queries)
- Custom type definitions

### Exported To Client

Client uses:
- API route types (for Eden Treaty)
- Custom utility types
- Never uses Prisma (that's API-only)

## Development Workflow

### When Database Changes

```bash
# 1. Make schema change in db/prisma/schema.prisma
# 2. Create migration
cd db
bun run migrate:dev

# 3. Generate new Prisma client
bun run generate

# 4. Types auto-update in shared/
# 5. API can import and use new types
# 6. Restart API server
```

### When API Routes Change

```bash
# 1. Add/modify routes in api/src/routes/
# 2. API types auto-generate (watch mode)
# 3. Client automatically gets new types
# 4. Use in client with full type safety
```

### When Adding Custom Types

```bash
# 1. Create file in shared/types/
# 2. Export from shared/index.ts
# 3. Import in api or client:
#    import type { MyType } from '@band-together/shared'
```

## Testing Shared Types

```typescript
// Test that types are exported correctly
import { PrismaClient } from '@band-together/shared'
import type { App } from '@band-together/shared'
import type { User } from '@band-together/shared'

describe('Shared Types', () => {
  it('should have PrismaClient', () => {
    expect(PrismaClient).toBeDefined()
  })

  it('should export API types', () => {
    // Type-only test, just ensures types exist
    const _app: App = {} as any
  })

  it('should export custom types', () => {
    const _user: User = {} as any
  })
})
```

## See Also

- [Project Structure](../wiki/Project-Structure.md) — Overall structure
- [Architecture](../wiki/Architecture.md) — System design & type safety
- [Database Schema](../wiki/Database-Schema.md) — Database models
- [API Documentation](../wiki/API-Documentation.md) — API types
- [Development Guide](../wiki/Development-Guide.md) — Daily workflows
- [Contributing](../wiki/Contributing.md) — How to add features
- [AI Agents Guide](../wiki/AI-Agents.md) — For all AI agents

---

**Last Updated**: 2026-01-17

**For**: Claude, ChatGPT, or other AI agents assisting with shared module
